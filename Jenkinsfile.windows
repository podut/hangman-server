pipeline {
    agent any
    
    environment {
        // Python paths
        PYTHON_CMD = 'python'
        VENV_PATH = '.venv'
        
        // Application settings
        // TEMP: Hardcoded for testing (replace with credentials('hangman-secret-key') in production)
        SECRET_KEY = 'dev-secret-key-minimum-32-chars-long-for-development-only'
        DEBUG = 'false'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
        disableConcurrentBuilds()
        timestamps()
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ðŸ“¥ Checking out code...'
                checkout scm
            }
        }
        
        stage('Validate Secrets') {
            steps {
                script {
                    echo 'ðŸ”‘ Validating required credentials...'
                    
                    if (!env.SECRET_KEY) {
                        error "âŒ Missing SECRET_KEY environment variable!"
                    }
                    
                    echo "âœ… SECRET_KEY present (length: ${env.SECRET_KEY.length()} chars)"
                }
            }
        }
        
        stage('Setup Environment') {
            steps {
                echo 'ðŸ”§ Setting up Python environment...'
                
                bat """
                    ${PYTHON_CMD} --version
                    ${PYTHON_CMD} -m venv ${VENV_PATH}
                    call ${VENV_PATH}\\Scripts\\activate.bat
                    python -m pip install --upgrade pip
                """
            }
        }
        
        stage('Install Dependencies') {
            steps {
                echo 'ðŸ“¦ Installing dependencies...'
                
                bat """
                    call ${VENV_PATH}\\Scripts\\activate.bat
                    cd server
                    pip install -r requirements.txt
                """
            }
        }
        
        stage('Run Tests') {
            steps {
                echo 'ðŸ§ª Running tests...'
                
                bat """
                    call ${VENV_PATH}\\Scripts\\activate.bat
                    pytest server/tests/test_new_features.py -v --tb=short ^
                        --cov=server/src ^
                        --cov-report=xml:coverage.xml ^
                        --cov-report=html:coverage_html ^
                        --junitxml=test-results.xml
                """
            }
            
            post {
                always {
                    junit 'test-results.xml'
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'coverage_html',
                        reportFiles: 'index.html',
                        reportName: 'Coverage Report'
                    ])
                }
            }
        }
        
        stage('WebSocket Tests') {
            steps {
                echo 'ðŸ”Œ Testing WebSocket...'
                
                bat """
                    call ${VENV_PATH}\\Scripts\\activate.bat
                    
                    REM Start server in background
                    start /B python -m uvicorn server.src.main:app --host 0.0.0.0 --port 8888
                    
                    REM Wait for startup
                    timeout /t 5 /nobreak
                    
                    REM Run WebSocket test
                    python test_websocket.py
                    
                    REM Kill server
                    taskkill /F /IM python.exe /T
                """
            }
        }
        
        stage('Generate OpenAPI') {
            steps {
                echo 'ðŸ“„ Generating OpenAPI specs...'
                
                bat """
                    call ${VENV_PATH}\\Scripts\\activate.bat
                    cd server
                    python export_openapi.py
                """
                
                archiveArtifacts artifacts: 'docs/openapi.yaml,docs/openapi.json'
            }
        }
    }
    
    post {
        success {
            echo 'âœ… Pipeline succeeded!'
        }
        
        failure {
            echo 'âŒ Pipeline failed!'
        }
        
        always {
            script {
                echo 'ðŸ§¹ Cleaning up test environment...'
                
                // Clean workspace - must run inside node context
                node {
                    // Forcefully remove virtual environment and temp files (Windows)
                    bat '''
                        echo ðŸ—‘ï¸ Removing virtual environment...
                        if exist .venv rmdir /s /q .venv 2>nul
                        
                        echo ðŸ—‘ï¸ Removing Python cache files...
                        for /d /r %%d in (__pycache__) do @if exist "%%d" rmdir /s /q "%%d" 2>nul
                        del /s /q *.pyc 2>nul
                        del /s /q *.pyo 2>nul
                        
                        echo ðŸ—‘ï¸ Removing test artifacts...
                        if exist coverage_html rmdir /s /q coverage_html 2>nul
                        if exist .coverage del /q .coverage 2>nul
                        if exist coverage.xml del /q coverage.xml 2>nul
                        if exist test-results.xml del /q test-results.xml 2>nul
                        
                        echo ðŸ—‘ï¸ Removing build artifacts...
                        if exist build rmdir /s /q build 2>nul
                        if exist dist rmdir /s /q dist 2>nul
                        if exist .pytest_cache rmdir /s /q .pytest_cache 2>nul
                        if exist .mypy_cache rmdir /s /q .mypy_cache 2>nul
                        
                        echo âœ… Cleanup complete!
                    '''
                    
                    // Final workspace cleanup (removes everything)
                    cleanWs(
                        deleteDirs: true,
                        disableDeferredWipeout: true,
                        notFailBuild: true
                    )
                }
                
                echo 'ðŸŽ¯ Test environment completely removed'
            }
        }
    }
}
